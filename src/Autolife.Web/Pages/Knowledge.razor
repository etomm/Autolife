@page "/knowledge"
@using Autolife.Core.Interfaces
@using Autolife.Core.Models
@inject IKnowledgeService KnowledgeService
@inject NavigationManager Navigation

<PageTitle>Knowledge - Autolife</PageTitle>

<div class="knowledge-container">
    <div class="page-header">
        <h1><i class="bi bi-book"></i> Knowledge Base</h1>
        <button class="btn btn-primary" @onclick="() => showCreateDialog = true">
            <i class="bi bi-plus-lg"></i> New Entry
        </button>
    </div>

    <div class="search-bar">
        <input type="text" class="form-control" placeholder="Search knowledge base..." @bind="searchQuery" @bind:event="oninput" @onkeyup="Search" />
        <button class="btn btn-outline-primary" @onclick="Search">
            <i class="bi bi-search"></i> Search
        </button>
    </div>

    @if (isLoading)
    {
        <div class="text-center p-4">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (displayedEntries.Any())
    {
        <div class="knowledge-grid">
            @foreach (var entry in displayedEntries)
            {
                <div class="knowledge-card" @onclick="() => ViewEntry(entry)">
                    <h3>@entry.Title</h3>
                    <p>@(entry.Summary ?? entry.AiGeneratedSummary ?? "No summary available")</p>
                    <div class="card-footer">
                        @if (!string.IsNullOrWhiteSpace(entry.Category))
                        {
                            <span class="badge">@entry.Category</span>
                        }
                        <span class="date">@entry.UpdatedAt.ToShortDateString()</span>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="empty-state">
            <div class="empty-icon">
                <i class="bi bi-book"></i>
                <div class="slash"></div>
            </div>
            <h3>No knowledge entries yet</h3>
            <p>Start building your personal knowledge base by creating your first entry.</p>
            <button class="btn btn-primary" @onclick="() => showCreateDialog = true">Create First Entry</button>
        </div>
    }
</div>

@if (showCreateDialog)
{
    <div class="modal-backdrop" @onclick="() => showCreateDialog = false"></div>
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5>Create Knowledge Entry</h5>
                <button class="btn-close" @onclick="() => showCreateDialog = false"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Title *</label>
                    <input type="text" class="form-control" @bind="newEntry.Title" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Category</label>
                    <input type="text" class="form-control" @bind="newEntry.Category" placeholder="e.g., Tutorial, Reference, Guide" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Content *</label>
                    <textarea class="form-control" rows="6" @bind="newEntry.Content" placeholder="Enter your knowledge content here..."></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Summary (optional - AI can generate)</label>
                    <textarea class="form-control" rows="2" @bind="newEntry.Summary" placeholder="Brief summary of the content"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="() => showCreateDialog = false">Cancel</button>
                <button class="btn btn-primary" @onclick="CreateEntry" disabled="@(string.IsNullOrWhiteSpace(newEntry.Title) || string.IsNullOrWhiteSpace(newEntry.Content))">Create</button>
            </div>
        </div>
    </div>
}

@code {
    private string searchQuery = "";
    private List<KnowledgeEntry> allEntries = new();
    private List<KnowledgeEntry> displayedEntries = new();
    private bool isLoading = true;
    private bool showCreateDialog = false;
    private KnowledgeEntry newEntry = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadEntries();
    }

    private async Task LoadEntries()
    {
        isLoading = true;
        try
        {
            allEntries = (await KnowledgeService.GetAllAsync()).ToList();
            displayedEntries = allEntries;
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task Search()
    {
        if (string.IsNullOrWhiteSpace(searchQuery))
        {
            displayedEntries = allEntries;
        }
        else
        {
            displayedEntries = (await KnowledgeService.SearchAsync(searchQuery)).ToList();
        }
    }

    private async Task CreateEntry()
    {
        try
        {
            await KnowledgeService.CreateAsync(newEntry);
            showCreateDialog = false;
            newEntry = new KnowledgeEntry();
            await LoadEntries();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error creating entry: {ex.Message}");
        }
    }

    private void ViewEntry(KnowledgeEntry entry)
    {
        // TODO: Navigate to detail view
        Console.WriteLine($"Viewing entry: {entry.Title}");
    }
}

<style>
    .knowledge-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }

    .page-header h1 {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin: 0;
    }

    .page-header h1 i {
        color: #667eea;
    }

    .search-bar {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .search-bar input {
        flex: 1;
    }

    .knowledge-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1.5rem;
    }

    .knowledge-card {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .knowledge-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }

    .knowledge-card h3 {
        margin: 0 0 0.5rem 0;
        color: #2c3e50;
    }

    .knowledge-card p {
        color: #7f8c8d;
        margin: 0 0 1rem 0;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .card-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .badge {
        background: #667eea;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.85rem;
    }

    .date {
        color: #95a5a6;
        font-size: 0.85rem;
    }

    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .empty-icon {
        position: relative;
        display: inline-block;
        margin-bottom: 1rem;
    }

    .empty-icon i {
        font-size: 4rem;
        color: #cbd5e0;
    }

    .empty-icon .slash {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 120%;
        height: 3px;
        background: #e53e3e;
        transform: translate(-50%, -50%) rotate(-45deg);
        border-radius: 2px;
    }

    .empty-state h3 {
        color: #2c3e50;
        margin-bottom: 0.5rem;
    }

    .empty-state p {
        color: #7f8c8d;
        margin-bottom: 2rem;
    }

    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1040;
    }

    .modal-dialog {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1050;
        width: 90%;
        max-width: 600px;
    }

    .modal-content {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 24px rgba(0,0,0,0.2);
    }

    .modal-header {
        padding: 1.5rem;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-body {
        padding: 1.5rem;
    }

    .modal-footer {
        padding: 1rem 1.5rem;
        border-top: 1px solid #e9ecef;
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
    }
</style>